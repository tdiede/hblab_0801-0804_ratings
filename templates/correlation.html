{% extends 'base.html' %}
{% block content %}

<!-- <h2>Correlation</h2> -->

<h4>CORRELATION | <span class="subtitle"> Select 2 users to calculate their similarity:</span></h4>


<hr class="blur">


<form class="navbar-form navbar-left" action="/correlogram.csv" method="POST">
    <label>correlate only users who have rated __+ movies:</label>
    <input type="number" name="movielimit" min="0" max="500" placeholder="0-500">
    <button type="submit" class="btn" name="submit">CORRELATE</button>
</form>



<script src="https://d3js.org/d3.v4.min.js"></script>
<style>
svg {
  font: 12px sans-serif;
  text-anchor: middle;
}

rect {
  stroke: lightgray;
  stoke-width: 1px;
  fill: none;
}

.y.axis path{
  fill: none;
  stroke: none;
}

</style>
<script>

$(document).ready(function() {

    let winWidth = $(window).width();



    d3.csv("/data", function(error, rows) {
        if (error) throw error;

        console.table(rows);

        const data = [];
        console.log(data);
        console.log(data.length);

        rows.forEach(function(d) {
            let x = d[""];
            console.log('x = ' + x);
            delete d[""];
            for (prop in d) {
                let y = prop;
                console.log('y - ' +y);
                console.log('value'+d[prop]);
                let value = d[prop];
                data.push({
                    x: x,
                    y: y,
                    value: +value
                    });
                }
                console.log(data);
            });

        const margin = {top: 25,right: 80,bottom: 25,left: 25},
              width = 800 - margin.left - margin.right,
              height = 800 - margin.top - margin.bottom;

        let domain = d3.set(data.map(function(d) { return d.x })).values(),
            num = Math.sqrt(data.length);

        let color = d3.scaleLinear().domain([-1, 0, 1]).range(["#B22324", "#F280A0", "#000080"]);
        let x = d3.scaleOrdinal().range([0, width]).domain(domain),
            y = d3.scaleOrdinal().range([0, height]).domain(domain),
            xSpace = x.range()[1] - x.range()[0],
            ySpace = y.range()[1] - y.range()[0];

        svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let correlation = svg.selectAll(".correlation")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "correlation")
            .attr("transform", function(d) {
                return "translate(" + x(d.x) + "," + y(d.y) + ")";
            });
        
        correlation.append("rect")
            .attr("width", xSpace)
            .attr("height", ySpace)
            .attr("x", -xSpace / 2)
            .attr("y", -ySpace / 2)

        correlation.filter(function(d){
            let ypos = domain.indexOf(d.y);
            let xpos = domain.indexOf(d.x);
            for (let i = (ypos + 1); i < num; i++){ if (i === xpos) return false; }
                return true;
            })
            .append("text")
            .attr("y", 5)
            .text(function(d) { if (d.x === d.y) { return d.x; } else { return d.value.toFixed(2); }
            })
            .style("fill", function(d){ if (d.value === 1) { return "#000"; } else { return color(d.value); }
            });

        correlation.filter(function(d){
            let ypos = domain.indexOf(d.y);
            let xpos = domain.indexOf(d.x);
            for (var i = (ypos + 1); i < num; i++){
                if (i === xpos) return true;
            }
            return false;
            })
            .append("circle")
            .attr("r", (width / (num * 2) - 5))
            .style("fill", function(d){
                if (d.value === 1) { return "#000"; } else {
            return color(d.value);
            }
            });

        let aS = d3.scaleLinear().range([-margin.top + 5, height + margin.bottom - 5]).domain([1, -1]);

        let yA = d3.axisRight()
            .scale(aS)
            .tickPadding(7);

        let aG = svg.append("g")
            .attr("class", "y axis")
            .call(yA)
            .attr("transform", "translate(" + (width + margin.right / 2) + " ,0)")

        let iR = d3.range(-1, 1.01, 0.01);
        let h = height / iR.length + 3;
        iR.forEach(function(d){
            aG.append('rect')
                .style('fill',color(d))
                .style('stroke-width', 0)
                .style('stoke', 'none')
                .attr('height', h)
                .attr('width', 10)
                .attr('x', 0)
                .attr('y', aS(d))
            });
        });
    });

  </script>


{% endblock %}

